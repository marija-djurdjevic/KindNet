<div class="form-wrapper">
  <div class="form-container">
    <h2>{{ isEditMode ? 'Izmijeni događaj' : 'Kreiraj novi događaj' }}</h2>
    <form class="event-form" #eventForm="ngForm">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Naziv događaja</mat-label>
        <input matInput placeholder="Naziv događaja" [(ngModel)]="event.name" name="name" required #name="ngModel">
        <mat-error *ngIf="name.invalid && (name.dirty || name.touched)">
          Naziv događaja je obavezan.
        </mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Opis</mat-label>
        <textarea matInput placeholder="Opis događaja" cdkTextareaAutosize cdkAutosizeMinRows="3" [(ngModel)]="event.description" name="description" required #description="ngModel"></textarea>
        <mat-error *ngIf="description.invalid && (description.dirty || description.touched)">
          Opis je obavezan.
        </mat-error>
        <mat-icon
          matSuffix
          class="help-icon"
          [matTooltip]="'Opis se može formatirati koristeći markdown. Klikni da vidiš sintaksu.'"
          matTooltipPosition="above"
          (click)="openMarkdownHelp()">
          help_outline
        </mat-icon>
      </mat-form-field>

      <div *ngIf="event.description" class="markdown-preview-container">
        <h4>Pregled opisa</h4>
        <div class="markdown-preview-box">
          <markdown [data]="event.description"></markdown>
        </div>
      </div>

      <div class="date-time-group">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Datum početka</mat-label>
          <input matInput [matDatepicker]="startDatePicker" [(ngModel)]="startTimeDate" name="startTimeDate" required #startDate="ngModel">
          <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #startDatePicker></mat-datepicker>
          <mat-error *ngIf="startDate.invalid && (startDate.dirty || startDate.touched)">
            Datum početka je obavezan.
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Vrijeme početka</mat-label>
          <input matInput type="time" [(ngModel)]="startTimeTime" name="startTimeTime" required #startTime="ngModel">
          <mat-error *ngIf="startTime.invalid && (startTime.dirty || startTime.touched)">
            Vrijeme početka je obavezno.
          </mat-error>
        </mat-form-field>
      </div>

      <div class="date-time-group">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Datum završetka</mat-label>
          <input matInput [matDatepicker]="endDatePicker" [(ngModel)]="endTimeDate" name="endTimeDate" required #endDate="ngModel">
          <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
          <mat-datepicker #endDatePicker></mat-datepicker>
          <mat-error *ngIf="endDate.invalid && (endDate.dirty || endDate.touched)">
            Datum završetka je obavezan.
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Vrijeme završetka</mat-label>
          <input matInput type="time" [(ngModel)]="endTimeTime" name="endTimeTime" required #endTime="ngModel">
          <mat-error *ngIf="endTime.invalid && (endTime.dirty || endTime.touched)">
            Vrijeme završetka je obavezno.
          </mat-error>
        </mat-form-field>
      </div>
      
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Rok za prijavu</mat-label>
        <input matInput [matDatepicker]="deadlinePicker" [(ngModel)]="event.applicationDeadline" name="applicationDeadline" required #deadline="ngModel">
        <mat-datepicker-toggle matSuffix [for]="deadlinePicker"></mat-datepicker-toggle>
        <mat-datepicker #deadlinePicker></mat-datepicker>
        <mat-error *ngIf="deadline.invalid && (deadline.dirty || deadline.touched)">
          Rok za prijavu je obavezan.
        </mat-error>
      </mat-form-field>

      <div class="half-width-container">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Grad</mat-label>
          <input matInput placeholder="Unesite grad" [(ngModel)]="event.city" name="city" required #city="ngModel">
          <mat-error *ngIf="city.invalid && (city.dirty || city.touched)">
            Grad je obavezan.
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Tip događaja</mat-label>
          <mat-select [(ngModel)]="event.type" name="type" required (selectionChange)="onTypeChange()" #type="ngModel">
            <mat-option value="Environmental">Ekološki</mat-option>
            <mat-option value="Cultural">Kulturni</mat-option>
            <mat-option value="Educational">Edukativni</mat-option>
            <mat-option value="Humanitarian">Humanitarni</mat-option>
            <mat-option value="Sport">Sportski</mat-option>
            <mat-option value="Community">Društveni</mat-option>
            <mat-option value="Technology">Tehnološki</mat-option>
          </mat-select>
          <mat-error *ngIf="type.invalid && (type.dirty || type.touched)">
            Tip događaja je obavezan.
          </mat-error>
        </mat-form-field>
      </div>
      
      <div class="full-width skills-section" *ngIf="event.type">
        <mat-label class="skills-label">Potrebne vještine</mat-label>
        <div class="skills-checkbox-group">
          <mat-checkbox *ngFor="let skill of suggestedSkills"
                        [value]="skill"
                        [checked]="selectedSkills.includes(skill)"
                        (change)="onSkillSelect(skill, $event)">
            {{ skill }}
          </mat-checkbox>
        </div>
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Ostale vještine (odvojite zarezom)</mat-label>
          <input matInput placeholder="Npr. programiranje, komunikacija, dizajn" [(ngModel)]="otherSkills" name="otherSkills">
        </mat-form-field>
      </div>

    <div class="resources-section">
  <button mat-stroked-button color="primary" type="button" (click)="addResource()">
    <mat-icon>add</mat-icon> Dodaj zahtjev za resurs
  </button>

  <div class="resource-cards-container" *ngIf="event.resourceRequests.length > 0">
  <mat-card *ngFor="let resource of event.resourceRequests; let i = index" class="resource-card">
    <mat-card-content>
      <div class="resource-header">
        <h3 class="resource-name">{{ resource.itemName }}</h3>
         <div class="category-badge" [ngClass]="getCategoryClass(resource.category)" [matTooltip]="getResourceCategoryName(resource.category)">
    <mat-icon>{{ getCategoryIcon(resource.category) }}</mat-icon>
  </div>
      </div>
      <div class="resource-details">
        <div class="detail-item">
          <span class="quantity-badge">{{ resource.quantityNeeded }}</span>
          <p>Potrebna količina</p>
        </div>
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-icon-button color="warn" (click)="removeResource(i)" matTooltip="Ukloni resurs">
        <mat-icon>delete_outline</mat-icon>
      </button>
    </mat-card-actions>
  </mat-card>
</div>
</div>


      <div class="button-container">
        <button mat-flat-button 
          class="save-button" 
          type="submit" 
          [disabled]="!eventForm.form.valid"
          (click)="onSubmit(eventForm, 'Draft')">
          Sačuvaj nacrt
        </button>
        
        <button mat-flat-button 
          class="save-button" 
          type="button" 
          [disabled]="!eventForm.form.valid"
          (click)="onSubmit(eventForm, 'Planned')">
          Sačuvaj i objavi
        </button>
        <button mat-flat-button class="cancel-button" type="button" routerLink="/dogadjaji">Otkaži</button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay" *ngIf="showModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Obavještenje</h4>
        <button type="button" class="close" (click)="closeModal()">&times;</button>
      </div>
      <div class="modal-body">
        <p>{{ modalMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" *ngIf="modalAction !== 'none'" (click)="closeModal()">Otkaži</button>
        <button type="button" class="btn btn-primary" *ngIf="modalAction !== 'none' && modalAction !== 'save'" (click)="performModalAction()">Nastavi</button>
        <button type="button" class="btn btn-primary" *ngIf="modalAction === 'save'" (click)="performModalAction()">Potvrdi</button>
        <button type="button" class="btn btn-primary" *ngIf="modalAction === 'none'" (click)="closeModal()">Ok</button>
      </div>
    </div>
  </div>
</div>

<ng-template #markdownHelpTemplate>
  <h2 mat-dialog-title>Markdown sintaksa - Brzi vodič</h2>
  <mat-dialog-content>
    <p>Možete formatirati tekst koristeći jednostavne simbole. Na ovaj način možete kreirati jasne i pregledne opise događaja.</p>
    
    <h3>Stilovi teksta</h3>
    <div class="markdown-section-example">
      <div class="markdown-syntax-col">
        <h4>Sintaksa:</h4>
        <p><code>**podebljan tekst**</code></p>
        <p><code>*nakošen tekst*</code></p>
        <p><code>&lt;u&gt;podvučen tekst&lt;/u&gt;</code></p>
      </div>
      <div class="markdown-result-col">
        <h4>Rezultat:</h4>
        <p><b>podebljan tekst</b></p>
        <p><i>nakošen tekst</i></p>
        <p><u>podvučen tekst</u></p>
      </div>
    </div>

    <h3>Naslovi</h3>
    <p>Koristite hashtag (<code>#</code>) za kreiranje naslova. Što više hashtaga, to je naslov manji:</p>
    <div class="markdown-section-example">
      <div class="markdown-syntax-col">
        <h4>Sintaksa:</h4>
        <p><code># Naslov 1</code></p>
        <p><code>## Naslov 2</code></p>
        <p><code>### Naslov 3</code></p>
      </div>
      <div class="markdown-result-col">
        <h4>Rezultat:</h4>
        <h1>Naslov 1</h1>
        <h2>Naslov 2</h2>
        <h3>Naslov 3</h3>
      </div>
    </div>
    
    <h3>Liste</h3>
    <p>Za liste koristite crtice ili brojeve:</p>
    <div class="markdown-section-example">
      <div class="markdown-syntax-col">
        <h4>Sintaksa:</h4>
        <p>Lista sa tačkama:</p>
        <pre>- Prva stavka
- Druga stavka</pre>
        <p>Numerisana lista:</p>
        <pre>1. Prva stavka
2. Druga stavka</pre>
      </div>
      <div class="markdown-result-col">
        <h4>Rezultat:</h4>
        <p>Lista sa tačkama:</p>
        <ul>
          <li>Prva stavka</li>
          <li>Druga stavka</li>
        </ul>
        <p>Numerisana lista:</p>
        <ol>
          <li>Prva stavka</li>
          <li>Druga stavka</li>
        </ol>
      </div>
    </div>

  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Zatvori</button>
  </mat-dialog-actions>
</ng-template>